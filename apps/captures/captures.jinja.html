{% extends "base.jinja.html" %}
{% import "macros.jinja.html" as macros -%}

{% block stylesheets %}
    {{ macros.staticAsset('captures', 'captures.css') }}
{% endblock %}

{% block scripts %}
    {{ macros.vueApp('main', ('clipboard-button',)) }}
{% endblock %}

{% block page_body %}
    {{ macros.svgSymbols("copy", "delete", "arrow-right", "arrow-left", "link") }}

    <main>
        <header id="app-nav">
            <form method="get" action="{{ app_url }}">
                <div class="field">
                    <input
                        type="search"
                        id="path"
                        name="path"
                        value="{{ path }}"
                        autocapitalize="none"
                        placeholder="URL"
                    />
                </div>
                <div>
                    <button>Search</button>
                </div>
            </form>
        </header>

        {% if not captures %}
            <p>No captures found.</p>
        {% endif %}

        {% for capture in captures %}
            <section>
                <div class="capture">
                    <header>
                        <div>
                            #{{ capture.rowid}} {{ capture.created|localtime|dateformat("LLL")}}
                        </div>

                        <a href="{{ app_url }}/{{ capture.rowid }}">
                            <svg class="icon"><use xlink:href="#icon-link"></use></svg>
                        </a>
                    </header>

                    <div class="reqhead">
                        <header>Request Headers
                            <div class="options">
                                <clipboard-button target-id="{{ "reqhead-" ~ loop.index }}" tooltip="Copy headers" />
                            </div>
                        </header>

                        <code id="reqhead-{{ loop.index }}">
                            {#- The awkward indentation here prevents unwanted whitespace during copy-to-clipboard -#}
{{- capture.request_line }}
{%  for key, value in capture.request.headers.items() -%}
    {{ key }}: {{ value }}
{% endfor -%}
                        </code>
                    </div>

                    <div class="reqresponse">
                        <header>Response</header>
                        <p>{{ capture.response.status }}</p>
                    </div>

                    {% if capture.request.params %}
                        <div class="reqbody">
                            <header>
                                Request Body
                                <div class="options">
                                    <clipboard-button
                                        target-id="{{ "reqbodyparam-" ~ loop.index }}"
                                        tooltip="Copy body"
                                    />
                                </div>
                            </header>
                            <code id="reqbodyparam-{{ loop.index }}">{{ capture.request.params }}</code>
                        </div>
                    {% endif %}

                    {% if capture.request.json %}
                        <div class="reqbody">
                            <header>
                                Request JSON
                                <div class="options">
                                    <clipboard-button
                                        target-id="{{ "reqbodyjson-" ~ loop.index }}"
                                        tooltip="Copy JSON"
                                    />
                                </div>
                            </header>

                            <pre id="reqbodyjson-{{ loop.index }}">{{ capture.request.json|json }}</pre>
                        </div>
                    {% endif %}
                </div>
            </section>
        {% endfor %}

        {% if pagination_url %}
            {{ macros.pagination(pagination_url, offset, per_page, total_records) }}
        {% endif %}

    </main>
{% endblock %}

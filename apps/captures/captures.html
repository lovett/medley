{% extends "base.html" %}
{% import "macros.html" as macros -%}

{% block stylesheets %}
{{ macros.cacheBustedStylesheet('captures', 'captures.css') }}
{% endblock %}

{% block scripts %}
{{ macros.cacheBustedScript('shared', 'js/copy-to-clipboard.js') }}
{% endblock %}

{% block page_body %}

<main>

    <form class="content-wrapper" method="get" action="/captures">
        <div class="field">
            <label for="number">Request URI</label>
            <input type="text" id="path" name="path" value="{{ path|default('', true) }}"/>
        </div>
        <div class="field">
            <button>Search</button>
        </div>
    </form>

    <div class="content-wrapper">
        {% if not captures %}
        <p>No captures found.</p>
        {% endif %}

        {% for capture in captures %}
        <div class="capture">
            <header>
                <a href="/captures?cid={{ capture.rowid }}">
                    <svg class="icon icon-link"><use xlink:href="#icon-link"></use></svg>
                </a>

                <div>
                    #{{ capture.rowid}} {{ capture.created|localtime("datetime12")}}
                </div>

            </header>

            <div class="half-column">
                <section>
                    <div class="options">
                        {{ macros.copyToClipboardBySelector("#reqhead-" ~ loop.index) }}
                    </div>
                    <h2>Request Headers</h2>

                    <code id="reqhead-{{ capture.rowid }}">
{#- The awkward indentation here prevents unwanted whitespace during copy-to-clipboard -#}
                    {{- capture.request_line }}
{%  for key, value in capture.request.headers.items() -%}
{{ key }}: {{ value }}
{% endfor -%}
                    </code>
                </section>

                {% if capture.request.params %}
                <section>
                    <div class="options">
                        {{ macros.copyToClipboardBySelector("#reqbodyparam-" ~ capture.rowid) }}
                    </div>
                    <h2>Request body</h2>
                    <code id="reqbodyparam-{{ capture.rowid }}">{{ capture.request.params }}</code>
                </section>
                {% endif %}

                {% if capture.request.json %}
                <section>
                    <div class="options">
                        {{ macros.copyToClipboardBySelector("#reqbodyjson-" ~ capture.rowid) }}
                    </div>
                    <h2>Request Body </h2>

                    <pre id="reqbodyjson-{{ capture.rowid }}">{{ capture.request.json|json }}</pre>
                </section>
                {% endif %}
            </div>

            <div class="half-column">
                <section>
                    <h2>Response</h2>
                    <p>{{ capture.response.status }}</p>
                </section>
            </div>
        </div>
        {% endfor %}

        {% if captures %}
        <div class="pagination">
            {% if newer_offset %}
            <a href="/captures?offset={{ newer_offset }}" rel="noreferrer" class="next">
                <svg class="icon icon-arrow-left"><use xlink:href="#icon-arrow-left"></use></svg>
                Newer
            </a>
            {% endif %}
            {% if older_offset %}
            <a href="/captures?offset={{ older_offset }}" rel="noreferrer" class="previous">
                Older
                <svg class="icon icon-arrow-right"><use xlink:href="#icon-arrow-right"></use></svg>
            </a>
            {% endif %}
        </div>
        {% endif %}

    </div>

</main>

{% endblock %}
